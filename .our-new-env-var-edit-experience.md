---
created: 2026-01-12 19:35:56
author: fl
title: The story of our new ENV vars edit experience
naviTitle: Our new ENV vars edit experience
intro: Building a fairly simple looking feature.
lead: "Editing ENV vars should be easy, right? Here's how we iterated to make it more powerful and developer-friendly, tackling devilish details."
draft: true
figure:
  emoji: ðŸ”–
  color: rgba(10, 60, 200, 1)
  textColor: rgba(255, 100, 1, 1)
  text: ENV var like a pro.
tag:
  - chronicles
head:
  meta:
    - name: 'keywords'
      content: 'ENV vars, base64'
---

## What it looks like now

![Edit ENV vars](/images/env-var-edit.gif)

And here's how we got there:

## It starts with a support request

A customer reported that an ENV var with a password mysteriously showed an incorrect value in PHP. Somehow, the string `3YD~YR#54$FK@KF8R*0XXX~7r` turned into something else.

The value `3YD~YR#54$FK@KF8R*0XXX~7r` was shortened because `$FK` was interpolated to an empty string. Similarly, if the string were `3YD~YR#54$FORTRABBIT_DB_NAME@KF8R*0XXX~7r`, it would replace `$FORTRABBIT_DB_NAME` with the database name.

This interpolation happens when customers set `CRAFT_DB_USER: '${FORTRABBIT_DB_USER}'`. It's also sometimes used by default in Laravel, for example: `VITE_APP_NAME: ${APP_NAME}`.

So, we want interpolation sometimes, but not always.

## Old platform

Dollar signs were not allowed at all. But interpolation still worked! How?

When a customer entered `NAME=${VALUE}`, it was transformed into `NAME=%%%VALUE%%%` and then put back. To handle passwords with dollar signs, we instructed customers to base64 encode them themselves.

## New platform

Dollar signs, double quotes, and many other characters that were forbidden on the old platform are now allowed. However, backslashes and single quotes are still not permitted.

Our internal API passes each environment value to the infrastructure as an array:

```yml
- key: TEST
  value: 123$FK@45
```

The operator then passes it on to the pod configuration:

```yml
- name: __FRBIT_ENV
  value: "TEST"
- name: __FRBIT_ENV_TEST
  value: 123$FK@45
```

Entrypoint scripts safely interpret and export all defined ENV vars. This file is then read in multiple places, such as when customers connect using SSH. Entrypoint scripts also write a list of variable names to `/etc/php/env-vars.php`.

This PHP file is read by our prepend script, and variables are loaded into `$_SERVER` but not `$_ENV` due to the `php.ini` setting: `variables_order = "GPCS"`. This ensures not all ENV vars are loaded into PHP.

## Possible solutions

### 1 - Escape dollar signs

In the dotenv world, the solution is to escape all dollar signs with `\$`. For example, customers would enter `123\$FK@45` to get `123$FK@45`.

However, the backslash character is forbidden. Why? We escape backslashes, which would make them ineffective for escaping dollar signs.

### 2 - Use single quotes

In Bash, surrounding the value with double quotes (`"123$FK@45"`) interpolates it, resulting in `123@45`. However, single quotes (`'123$FK@45'`) prevent interpolation, resulting in `123$FK@45`.

Unfortunately, this difference doesn't work with `.env` files (e.g., in `vlucas/phpdotenv`), so customers copying content from them won't be aware of this Bash feature.

Additionally, our backend strips all quotes from variables, and values are rewrapped in quotes when written. This makes it unsafe to change.

### 3 - Base64 encoding tool - our winner

If a customer prefixes an ENV var value with `base64:`, the infrastructure expects the value to be base64 encoded. The dashboard offers a small widgit to encode/decode values to base64.

Additionally, we can disallow a lone dollar sign to give customers an early error, ensuring they base64 encode passwords.

- Disallow single `$`
- Allow `${` when properly closed with `}` for interpolation

## Gotcha

Testing the new feature with our wonderful client revealed an oversight. Laravel has a `base64:` helper for ENV vars, which interferes with our implementation, spefically when NULL characters are present.

## Current state

To differentiate, our helper prefix is now `fr+base64:`. When used, variables within the environment are present normally without requiring decoding.

## Future

It's maybe still not the ideal solution. We may change it again if we find a better, less clicky solution.
